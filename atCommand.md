# EFR32BG22 BLE模块指令协议开发手册（全流程开发版）
## 一、协议基础信息
| 项目 | 说明 |
| --- | --- |
| 模块型号 | EFR32BG22（含RF-BM-BG22Ax/Bx/Cx系列） |
| BLE版本 | BLE 5.0（部分型号支持BLE 5.2特性） |
| 指令类型 | AT指令（需以CRLF\r\n结尾，+++除外） |
| 串口参数默认值 | 波特率115200、8位数据位、1位停止位、无校验 |
| 角色支持 | 从机（0）、主机（1）、主从模式（2）、Beacon模式（3） |
| 最大连接数 | 主机8个、主从模式7个（从机1个） |

## 二、基础配置指令（开发初始化必用）
| 指令功能 | 指令格式 | 参数说明 | 生效方式 | 开发场景 |
| --- | --- | --- | --- | --- |
| 进入AT指令模式 | `+++` | 无参数 | 立即生效 | 切换至指令配置模式，需先执行再配置参数 |
| 退出AT指令模式 | `AT+EXIT` | 无参数 | 立即生效 | 退出后进入透明传输模式，用于数据收发 |
| 设定设备角色 | `AT+ROLE=<角色值>` | 0=从机（默认）、1=主机、2=主从模式、3=Beacon模式 | 重启生效 | 主机/主从模式需主动扫描连接，从机被动等待连接 |
| 配置串口波特率 | `AT+UART=<波特率>` | 可选值：1200/2400/4800/9600/14400/19200/38400/56000/57600/115200（默认）/128000/230400/256000/460800/500000/512000/921600 | 立即生效+断电保存 | 需与MCU串口波特率匹配，避免通信异常 |
| 设定发射功率 | `AT+POWER=<功率值>` | 通用范围：-28/-20/-10/-5/-3/0/1/2/4/6 dBm；BG22A1仅支持：-28/-20/-10/-5/-3/0 dBm | 立即生效+断电保存 | 远距离设6dBm，近距离设-10~0dBm，平衡功耗与距离 |
| 控制串口回声 | `AT+ECHO=<0/1>` | 0=关闭（默认）、1=开启 | 立即生效（不保存） | 调试时开启回声验证指令是否被接收，量产时关闭 |
| 显示设备状态 | `AT+STATUS=<0/1>` | 0=关闭、1=开启（默认） | 立即生效（不保存） | 开启后显示连接/断开等状态信息，调试用 |
| 重启模块 | `AT+RESTART` | 无参数 | 立即生效 | 角色切换、MAC修改后需执行重启 |
| 恢复出厂设置 | `AT+RESET` | 无参数 | 立即生效（重启） | 清除所有配置，恢复默认参数（如设备名RFstar_XXXX） |
| 查询固件版本 | `AT+VERSION` | 无参数 | 立即返回 | 确认模块固件版本，匹配开发文档 |

## 三、设备扫描指令（主机/主从模式专用）
| 指令功能 | 指令格式 | 参数说明 | 生效方式 | 开发场景 |
| --- | --- | --- | --- | --- |
| 启动普通扫描 | `AT+SCAN=<扫描状态>,<超时时间>,<显示名称>,<重连扫描间隔>` | 1. 扫描状态：0=停止、1=启动<br>2. 超时时间：1~65535秒（扫描持续时间）<br>3. 显示名称：0=不显示、1=显示（默认）<br>4. 重连扫描间隔：1~255秒（仅自动重连开启时生效，默认3秒） | 立即生效 | 获取周围设备MAC/序号，例：`AT+SCAN=1,10,1,3`（扫描10秒，显示设备名） |
| 查询扫描状态 | `AT+SCAN?` | 无参数 | 立即返回 | 返回当前扫描状态、超时时间等，例：`AT+SCAN=0,10,1,3 OK` |
| 配置扫描PHY | `AT+SCAN_PHY=<0/1>` | 0=1M PHY（默认）、1=LE CODED PHY（长距离） | 立即生效+断电保存 | BG22A1/A1I不支持，长距离通信需开启 |
| 专项扫描设备名 | `AT+S_NAME=<0/1>` | 0=停止、1=启动 | 立即生效 | 仅扫描设备名称，返回格式：`MAC:XX:XX:XX:XX:XX:XX,RSSI:-XX,NAME:XXX` |
| 查询设备名扫描状态 | `AT+S_NAME?` | 无参数 | 立即返回 | 返回当前扫描状态，例：`AT+S_NAME=1 OK` |

## 四、配对与安全指令（可选，增强通信安全）
| 指令功能 | 指令格式 | 参数说明 | 生效方式 | 开发场景 |
| --- | --- | --- | --- | --- |
| 从机配对设置 | `AT+PAIR=<使能>,<配对密钥>` | 1. 使能：0=关闭、1=开启<br>2. 密钥：1~6位数字（默认123456） | 重启生效+断电保存 | 仅从机模式有效，需与主机配对密钥一致 |
| 主机配对方式设置 | `AT+MASTER_PAIR=<配对方式>` | 0=仅显示、1=显示+确认键、2=仅键盘（默认）、3=无输入输出、4=显示+键盘 | 重启生效+断电保存 | 主机/主从模式有效，根据交互场景选择方式 |
| 输入配对密钥（主机） | `AT+PASSKEY=<连接句柄>,<密钥>` | 1. 连接句柄：1~8（从`AT+CNT_LIST`获取）<br>2. 密钥：与从机`AT+PAIR`设定的一致 | 立即生效 | 主机连接需配对的从机时执行，例：`AT+PASSKEY=1,123456` |
| 查询配对列表 | `AT+PAIR_LIST` | 无参数 | 立即返回 | 返回已配对设备序号与MAC，例：`AT+PAIR_LIST=0(FF:1C:2B:D1:4C:BD) OK`（最多6个） |
| 删除配对设备 | `AT+PAIR_DEL=<序号/ALL>` | 1. 序号：从`AT+PAIR_LIST`获取<br>2. ALL：删除所有配对设备 | 立即生效+断电保存 | 删除单个：`AT+PAIR_DEL=0`；删除所有：`AT+PAIR_DEL=ALL`（删除后断开连接） |
| 启用用户认证 | `AT+AUTH=<使能>,<密钥>,<有效时间>` | 1. 使能：0=关闭、1=开启<br>2. 密钥：最多16字节可见字符（非空）<br>3. 有效时间：1~65535秒（默认15秒） | 重启生效+断电保存 | 需在有效时间内发送密钥，否则从机自动断开 |
| 输入认证密钥（主机） | `AT+AUTH_KEY=<连接句柄>,<密钥>` | 1. 连接句柄：1~8<br>2. 密钥：与从机`AT+AUTH`设定的一致 | 立即生效 | 主机认证从机时执行，例：`AT+AUTH_KEY=1,123456` |

## 五、设备连接指令（建立通信链路）
| 指令功能 | 指令格式 | 参数说明 | 生效方式 | 开发场景 |
| --- | --- | --- | --- | --- |
| 按序号连接设备 | `AT+CONNECT=<设备序号>` | 设备序号：从`AT+SCAN`结果获取（0、1、2...） | 立即生效 | 例：`AT+CONNECT=0`（连接扫描结果中序号0的设备） |
| 按MAC连接设备 | `AT+CONNECT=,<MAC地址>` | MAC地址：格式XX:XX:XX:XX:XX:XX（省略序号） | 立即生效 | 例：`AT+CONNECT=,F1:F2:F3:F4:F5:F6`（直接指定MAC连接） |
| 查询已连接设备 | `AT+CNT_LIST` | 无参数 | 立即返回 | 返回连接句柄与MAC，例：`AT+CNT_LIST=1*(FF:1C:2B:D1:4C:BD) OK`（*表示主机连接从机） |
| 设定连接间隔 | `AT+CNT_INTERVAL=<参数>` | 参数范围：6~3200，连接间隔=参数×1.25ms（对应7.5ms~4000ms，默认20ms） | 立即生效+断电保存 | 高频通信设小值（如16→20ms），低功耗设大值（如800→1000ms） |
| 启用自动重连 | `AT+AUTO_CNT=<使能>,<MAC地址>,<立即重连>` | 1. 使能：0=关闭、1=开启<br>2. MAC地址：可选，指定单设备；不填则对所有重连设备生效<br>3. 立即重连：0=不立即、1=立即（可选） | 立即生效+断电保存 | 例1：`AT+AUTO_CNT=1`（开启所有重连设备自动重连）<br>例2：`AT+AUTO_CNT=1,F1:F2:F3:F4:F5:F6,1`（指定设备立即重连） |
| 查询自动重连状态 | `AT+AUTO_CNT?` | 无参数 | 立即返回 | 返回设备MAC与重连使能状态，例：`AT+AUTO_CNT=1,FF:1C:2B:D1:4C:BD 0,EB:71:5B:DE:08:87 OK` |
| 删除自动重连设备 | `AT+DEV_DEL=<MAC地址/ALL>` | 1. MAC地址：指定设备<br>2. ALL：删除所有重连设备 | 立即生效+断电保存 | 例：`AT+DEV_DEL=FF:1C:2B:D1:4C:BD`（删除指定设备） |

## 六、数据收发指令（核心功能）
### （一）AT指令模式收发（精准控制单设备）
| 指令功能 | 指令格式 | 参数说明 | 生效方式 | 开发场景 |
| --- | --- | --- | --- | --- |
| 发送数据（AT模式） | `AT+SEND=<连接句柄>,<数据长度>,<超时时间>` | 1. 连接句柄：1~8（从`AT+CNT_LIST`获取）<br>2. 数据长度：1~3328字节<br>3. 超时时间：1~5000ms（默认500ms） | 立即生效 | 例：`AT+SEND=1,10,1000`（向句柄1设备发10字节数据，超时1秒），输入数据后自动发送 |
| 接收数据（AT模式） | 无指令 | 接收数据前缀：`+RECEIVED:<句柄>,<长度> <数据>` | 自动返回 | 例：`+RECEIVED:1,10 OUTPUT_BLE_DATA 123456789A OK` |

### （二）透明传输模式收发（批量数据）
| 指令功能 | 操作步骤 | 参数说明 | 生效方式 | 开发场景 |
| --- | --- | --- | --- | --- |
| 定向透明传输 | 1. 执行`AT+TTM_HANDLE=<连接句柄>`<br>2. 执行`AT+EXIT`退出AT模式 | 连接句柄：1~8（指定数据传输目标） | 立即生效（不保存） | 多设备连接时，确保数据仅发送给目标设备，例：`AT+TTM_HANDLE=2`（定向句柄2） |
| 发送数据（透明模式） | 退出AT模式后，通过MCU串口TX直接发送数据 | 数据格式：ASCII/HEX（无需指令包裹） | 自动转发 | 量产场景批量发送数据，模块自动通过BLE转发 |
| 接收数据（透明模式） | 无操作，模块自动将BLE接收数据通过串口RX输出 | 数据格式：与发送端一致（无前缀） | 自动输出 | 直接从MCU串口读取数据，无需解析指令前缀 |

### （三）UUID自定义通道收发（特殊需求）
| 指令功能 | 指令格式 | 参数说明 | 生效方式 | 开发场景 |
| --- | --- | --- | --- | --- |
| 开启UUID扫描 | `AT+UUID_SCAN=<0/1>` | 0=关闭、1=开启 | 立即生效+断电保存 | 主机连接从机后，自动打印从机特征UUID，例：`-CHAR:0 UUID:002A,Read;` |
| 配置UUID收发通道 | `AT+TRX_CHAN=<句柄>,<发送UUID序号>,<接收UUID序号>,<写属性>` | 1. 句柄：1~8<br>2. 发送UUID序号：从`AT+UUID_SCAN`结果获取（Write属性通道）<br>3. 接收UUID序号：从`AT+UUID_SCAN`结果获取（Notify/Indicate属性通道）<br>4. 写属性：0=Write Without Response、1=Write | 立即生效+断电保存（仅首设备） | 自定义数据通道，例：`AT+TRX_CHAN=1,8,7,0`（句柄1，发送序号8，接收序号7） |
| 读取UUID通道数据 | `AT+READ_UUID=<句柄>,<UUID序号>` | UUID序号：从`AT+UUID_SCAN`结果获取（Read属性通道） | 立即生效 | 读取指定UUID通道数据，例：`AT+READ_UUID=1,5` |

## 七、断开连接与低功耗指令
| 指令功能 | 指令格式 | 参数说明 | 生效方式 | 开发场景 |
| --- | --- | --- | --- | --- |
| 断开指定设备 | `AT+DISCONNECT=<角色>,<连接句柄>` | 1. 角色：0=断开从机、1=断开主机、2=断开主从设备<br>2. 句柄：1~8（从`AT+CNT_LIST`获取） | 立即生效 | 例：`AT+DISCONNECT=1,3`（主机断开句柄3的从机） |
| 断开所有设备 | `AT+DISCONNECT` | 无参数 | 立即生效 | 批量断开当前所有连接，例：执行后返回所有设备`DISCONNECTED` |
| 设定睡眠模式 | `AT+SLEEP=<串口使能>,<BLE使能>,<串口唤醒>` | 1. 串口使能：0=关闭、1=开启<br>2. BLE使能：0=关闭、1=开启<br>3. 串口唤醒：0=关闭、1=开启（默认关闭） | 立即生效（不保存） | 低功耗场景，例：`AT+SLEEP=0,0,0`（关闭串口、BLE、唤醒，深度睡眠） |
| 控制看门狗 | `AT+WDOG=<0/1>` | 0=关闭、1=开启（默认开启） | 重启生效+断电保存 | 关闭后功耗降低2~3μA，稳定性要求低的场景使用 |

## 八、开发注意事项（避坑指南）
1. **指令格式校验**：所有AT指令必须以CRLF（\r\n）结尾，仅`+++`无需结尾符，否则模块无法识别。
2. **角色切换影响**：执行`AT+ROLE`切换角色后，需`AT+RESTART`重启，且会清空配对/自动重连列表。
3. **CTS引脚处理**：CTS引脚（硬件流控）不可悬空，否则功耗升高、串口不稳定，无流控需求时需拉低。
4. **连接间隔协调**：`AT+CNT_INTERVAL`设定后，手机等主机可能协调为2倍值（如设10ms→实际20ms），需预留冗余。
5. **数据长度限制**：`AT+SEND`单次最大发送3328字节，透明传输无显式限制，但建议分帧（如2048字节/帧）避免丢包。
6. **Beacon模式限制**：Beacon模式（`AT+ROLE=3`）默认禁用串口，需拉低CTS引脚启用，且不支持Long Range广播。
7. **天线设计要求**：外部天线需垂直朝上暴露，PCB天线需远离金属遮挡，否则通信距离衰减>50%。
8. **焊接工艺标准**：无铅焊接（Sn96.5/Ag3.0/Cu0.5）峰值温度≤200℃，恒温时间30~90秒，避免高温损坏模块。